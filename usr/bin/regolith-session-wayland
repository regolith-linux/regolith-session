#!/bin/bash
# This script initializes Regolith Trawn resources and launches Sway.

set -Eeu -o pipefail
source /usr/lib/regolith/regolith-session-common.sh

# Try COSMIC session first
if command -v cosmic-session >/dev/null 2>&1; then
    export XDG_CURRENT_DESKTOP="Regolith:COSMIC"
    export XDG_SESSION_TYPE="wayland"
    
    resolve_default_config_file
    
    if [[ -z "${DBUS_SESSION_BUS_ADDRESS}" ]]; then
        exec /usr/bin/dbus-run-session -- cosmic-session sway -c "$SWAY_CONFIG_FILE"
    else
        exec cosmic-session sway -c "$SWAY_CONFIG_FILE"
    fi
fi

# Check if NOTIFY_SOCKET is available. This is used as a
# test to see if the session uses systemd
if [ -z "${NOTIFY_SOCKET-}" ]; then
  # Start trawl daemon manually
  trawld&

  # Export environmentt from Environment.d
  while read -r l; do
      eval export $l
  done < <(/usr/lib/systemd/user-environment-generators/30-systemd-environment-d-generator)
fi

# --------- Script Main -----------
resolve_default_config_file

load_standard_trawlres
load_regolith_trawlres

# workaround to prevent always loading the default look 
load_regolith_trawlres 

trawl_sway_cleanup

UPDATE_FLAG_DIR="$HOME/.config/regolith3/flags"
if [ ! -e "$UPDATE_FLAG_DIR" ]; then
    # flag file has not been created, meaning this is first session load
    # in this case, we need to configure some desktop settings from the look
    LOADER_PATH="$($RESOURCE_GETTER regolith.look.loader)"
    if [ -n  "$LOADER_PATH" ]; then
        # Load the look-specific script that has a function called load_look()
        source "$LOADER_PATH"
        # Call look function to update UI
        load_look
    fi
fi

# Set XDG_CURRENT_DESKTOP
if command -v cosmic-session >/dev/null 2>&1; then
    export XDG_CURRENT_DESKTOP="Regolith:COSMIC"
else
    export XDG_CURRENT_DESKTOP="Regolith-Wayland:GNOME:sway"
fi

# Start sway-regolith
unsupported_gpu=$(trawlcat regolith.sway.unsupported_gpu false)
echo "Regolith is launching Sway with $SWAY_CONFIG_FILE"

if [[ "${unsupported_gpu,,}" == "true" ]]; then
    if [[ -z "${DBUS_SESSION_BUS_ADDRESS}" ]]; then
        exec /usr/bin/dbus-run-session -- cosmic-session sway -c "$SWAY_CONFIG_FILE" --unsupported-gpu
    else
        sway -c "$SWAY_CONFIG_FILE" --unsupported-gpu
    fi
else
    if [[ -z "${DBUS_SESSION_BUS_ADDRESS}" ]]; then
        exec /usr/bin/dbus-run-session -- cosmic-session sway -c "$SWAY_CONFIG_FILE"
    else
        sway -c "$SWAY_CONFIG_FILE"
    fi
fi

# Run user's post logout script if script. Post logout means that the wayland session has been terminated.
if [ -f "$USER_POST_LOGOUT_SCRIPT_FILE" ] ; then
    echo "Regolith is launching user post-logout file $USER_POST_LOGOUT_SCRIPT_FILE"
	timeout --verbose 5 bash "$USER_POST_LOGOUT_SCRIPT_FILE"
fi
